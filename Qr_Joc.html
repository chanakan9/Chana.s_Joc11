<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR Code Check-In (No LIFF)</title>

<!-- html5-qrcode -->
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">

<style>
  body { font-family:'Kanit',sans-serif; margin:0; padding:20px; background:#f4f4f9; color:#222; display:flex; justify-content:center; }
  .container { width:100%; max-width:540px; }
  header { text-align:center; margin-bottom:18px; }
  header img { width:84px; }
  .card { background:#fff; border-radius:14px; padding:22px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
  h1 { margin:0 0 8px 0; font-size:20px; }
  p.sub { margin:0 0 18px 0; color:#666; }
  label { display:block; font-weight:700; margin-bottom:8px; }
  input[type="text"], input[type="tel"], select { width:100%; padding:12px; border-radius:10px; border:1px solid #d9d9d9; margin-bottom:16px; font-size:16px; box-sizing:border-box; }
  button { width:100%; padding:12px; border-radius:10px; border:0; background:#00B900; color:#fff; font-weight:700; font-size:16px; cursor:pointer; }
  button.secondary { background:#f44336; }
  .hidden { display:none; }
  #qr-reader { margin-top:14px; border:1px dashed #ccc; border-radius:10px; min-height:280px; }
  .message { margin-top:12px; font-weight:600; color:#333; }
  .modal { position:fixed; left:0; top:0; right:0; bottom:0; display:flex; align-items:flex-end; justify-content:center; z-index:999; pointer-events:none; }
  .modal .sheet { width:100%; max-width:540px; background:#fff; border-radius:14px 14px 0 0; padding:18px; box-shadow:0 -6px 20px rgba(0,0,0,0.15); pointer-events:auto; }
  .sheet h2 { margin:0 0 8px 0; font-size:18px; text-align:center; }
  .sheet .summary { font-size:16px; color:#222; line-height:1.6; margin:12px 0; }
  .sheet .buttons { display:flex; gap:12px; margin-top:12px; }
  .sheet .buttons button { flex:1; }
  .note { margin-top:12px; color:#666; font-size:14px; text-align:center; }
</style>
</head>
<body>
<div class="container">
  <header>
    <img src="https://drive.google.com/thumbnail?id=1biw0LeK_X0ntKPdH4-8XaPUcl1yGDl59" alt="Logo">
  </header>

  <div class="card" id="formCard">
    <h1>ระบบลงเวลาเข้าเรียน</h1>
    <p class="sub">ณ สศท.สปท.</p>

    <label for="inputName">ชื่อ (ระบุชื่อ/รหัส)</label>
    <input id="inputName" type="text" placeholder="เช่น B105 Chana.s" />

    <label for="inputPhone">หมายเลขโทรศัพท์</label>
    <input id="inputPhone" type="tel" placeholder="0xxxxxxxxx" pattern="^0[689]\d{8}$" />

    <button id="startScanBtn">เริ่มสแกน QR</button>
    <div class="note">เมื่อกดปุ่ม ระบบจะขออนุญาตใช้กล้อง เพื่อสแกน QR Code</div>
  </div>

  <div class="card hidden" id="scannerCard" style="margin-top:18px;">
    <h1>แสกน QR Code เพื่อประทับเวลา</h1>
    <div id="qr-reader"></div>
    <div id="scanInfo" class="message"></div>
    <button id="stopScanBtn" class="secondary" style="margin-top:12px;">หยุดสแกน</button>
  </div>

  <div class="card hidden" id="successCard" style="margin-top:18px;">
    <h1>รายงานการลงเวลา</h1>
    <div id="successText" class="message"></div>
    <button id="newScanBtn" style="margin-top:14px;">ลงเวลาใหม่</button>
  </div>
</div>

<!-- confirmation modal (bottom sheet style) -->
<div id="confirmModal" class="modal hidden" aria-hidden="true">
  <div class="sheet">
    <h2>สรุปผลการสแกน</h2>
    <div id="summaryText" class="summary"></div>
    <div class="buttons">
      <button id="rescanBtn" class="secondary">สแกนใหม่</button>
      <button id="confirmSendBtn">ยืนยันและส่งข้อมูล</button>
    </div>
    <div class="note">ข้อมูลจะถูกส่งไปยังระบบเดิมและ LINE OA ของหน่วยงาน</div>
  </div>
</div>

<script>
/*
  Single-page HTML:
  - No LIFF
  - Randomize location 5–10 meters from base
  - Use html5-qrcode scanner
  - Send data to provided GAS via JSONP (callback)
*/

const GAS_URL = 'https://script.google.com/macros/s/AKfycby8iE0HQ4V_8rgjHNalxp1bM4VFxxz5JBXkUc0qpqkLxcYxM1iE5vmhQO0wCoNG1eIfCg/exec';

let html5QrcodeScanner = null;
let currentForm = {}; // { Name, Phone, Secrete, Latitude, Longitude, Date, Time }
const BASE_LAT = 13.77922;
const BASE_LNG = 100.55861;

// Utility: random location within min–max meters from base
function randomLocation(minMeters = 5, maxMeters = 10) {
  const metersToDeg = 1 / 111111; // approx for lat
  const distance = Math.random() * (maxMeters - minMeters) + minMeters;
  const angle = Math.random() * Math.PI * 2;
  const dLat = Math.cos(angle) * distance * metersToDeg;
  const dLng = Math.sin(angle) * distance * metersToDeg / Math.cos(BASE_LAT * Math.PI / 180);
  return { latitude: BASE_LAT + dLat, longitude: BASE_LNG + dLng };
}

function formatDateTime(d = new Date()) {
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,'0');
  const min = String(d.getMinutes()).padStart(2,'0');
  return { date:`${dd}-${mm}-${yyyy}`, time:`${hh}:${min}` };
}

function show(el){ el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
function hide(el){ el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }

// JSONP call helper (for GAS that supports callback)
function callGAS(action, params = {}) {
  return new Promise((resolve, reject) => {
    const cbName = 'jsonp_cb_' + Date.now() + Math.floor(Math.random()*1000);
    window[cbName] = function(result){
      try { delete window[cbName]; script.remove(); } catch(e){}
      resolve(result);
    };
    const url = new URL(GAS_URL);
    url.searchParams.append('action', action);
    for (const k in params) url.searchParams.append(k, params[k]);
    url.searchParams.append('callback', cbName);
    const script = document.createElement('script');
    script.src = url.toString();
    script.onerror = () => {
      try { delete window[cbName]; script.remove(); } catch(e){}
      reject(new Error('Network / JSONP load error'));
    };
    document.body.appendChild(script);
  });
}

/* UI elements */
const startScanBtn = document.getElementById('startScanBtn');
const stopScanBtn = document.getElementById('stopScanBtn');
const rescanBtn = document.getElementById('rescanBtn');
const confirmSendBtn = document.getElementById('confirmSendBtn');
const newScanBtn = document.getElementById('newScanBtn');

const formCard = document.getElementById('formCard');
const scannerCard = document.getElementById('scannerCard');
const successCard = document.getElementById('successCard');
const confirmModal = document.getElementById('confirmModal');

const inputName = document.getElementById('inputName');
const inputPhone = document.getElementById('inputPhone');
const qrReaderDiv = document.getElementById('qr-reader');
const scanInfo = document.getElementById('scanInfo');
const summaryText = document.getElementById('summaryText');
const successText = document.getElementById('successText');

/* start scanning flow */
startScanBtn.addEventListener('click', async () => {
  const name = inputName.value.trim();
  const phone = inputPhone.value.trim();
  if (!name) { alert('กรุณากรอกชื่อ'); return; }
  if (!phone || !/^0[689]\d{8}$/.test(phone)) { alert('กรุณากรอกเบอร์มือถือให้ถูกต้อง'); return; }

  // prepare randomized location & base form fields
  const loc = randomLocation(5,10);
  const dt = formatDateTime(new Date());
  currentForm = {
    Name: name,
    Phone: phone,
    Latitude: loc.latitude,
    Longitude: loc.longitude,
    Date: dt.date,
    Time: dt.time,
    Secrete: '' // filled by QR
  };

  // show scanner UI
  hide(formCard);
  show(scannerCard);
  scanInfo.innerText = 'กำลังรอการสแกน QR...';
  startScanner();
});

stopScanBtn.addEventListener('click', () => {
  stopScanner();
  hide(scannerCard);
  show(formCard);
});

/* start html5-qrcode */
function startScanner() {
  // ensure previous stopped
  if (html5QrcodeScanner) {
    html5QrcodeScanner.clear().catch(()=>{});
    html5QrcodeScanner = null;
  }
  html5QrcodeScanner = new Html5Qrcode(/* element id */ "qr-reader", { verbose: false });
  const config = { fps: 10, qrbox: { width: 280, height: 280 } };
  html5QrcodeScanner.start(
    { facingMode: "environment" },
    config,
    qrSuccessCallback,
    qrErrorCallback
  ).catch(err => {
    console.error('start error', err);
    scanInfo.innerText = 'ไม่สามารถเปิดกล้องได้: ' + (err.message || err);
  });
}

function stopScanner() {
  if (html5QrcodeScanner) {
    html5QrcodeScanner.stop().then(() => {
      html5QrcodeScanner.clear().catch(()=>{});
      html5QrcodeScanner = null;
    }).catch(()=>{ html5QrcodeScanner = null; });
  }
}

/* callbacks */
function qrSuccessCallback(decodedText, decodedResult) {
  // stop scanning and show confirmation modal
  stopScanner();
  currentForm.Secrete = decodedText ? decodedText.trim() : '';
  const summary = `ลงเวลาสำเร็จ\n--------------------\nคุณ: ${currentForm.Name}\nเบอร์โทร: ${currentForm.Phone}\nวันที่: ${currentForm.Date}\nเวลา: ${currentForm.Time} น.`;
  summaryText.innerText = summary;
  show(confirmModal);
}

function qrErrorCallback(err) {
  // scan errors are frequent — don't spam UI, only update minimal
  console.debug('QR error', err);
}

/* modal buttons */
rescanBtn.addEventListener('click', () => {
  hide(confirmModal);
  show(scannerCard);
  scanInfo.innerText = 'กลับไปสแกนใหม่...';
  startScanner();
});

confirmSendBtn.addEventListener('click', async () => {
  // send to GAS via JSONP (action=add). The original system expects a 'text' param JSON string.
  hide(confirmModal);
  scanInfo.innerText = 'กำลังส่งข้อมูล...';
  show(scannerCard);

  // Build payload (match original 'text' JSON structure)
  const payload = {
    Name: currentForm.Name,
    Phone: currentForm.Phone,
    Date: currentForm.Date,
    Time: currentForm.Time,
    Latitude: currentForm.Latitude,
    Longitude: currentForm.Longitude,
    Secrete: currentForm.Secrete
  };

  try {
    // Many existing GAS endpoints expect "action=add" and text=JSON.stringify(form)
    const res = await callGAS('add', { text: JSON.stringify(payload) });
    // The original GAS normally returns { status: 'added', ... } on success
    if (res && (res.status === 'added' || res.status === 'ok' || res.result === 'added')) {
      // show success screen (UI only) — GAS will push message to LINE OA if it's wired to do so
      successText.innerText = `ลงเวลาสำเร็จ!\n\nคุณ: ${currentForm.Name}\nเบอร์โทร: ${currentForm.Phone}\nวันที่: ${currentForm.Date}\nเวลา: ${currentForm.Time} น.\n\nระบบเดิมจะส่งข้อความยืนยันใน LINE OA ของหน่วยงาน (หากการตั้งค่า GAS เชื่อมต่อถูกต้อง)`;
      hide(scannerCard);
      show(successCard);
    } else {
      // show error details if provided
      const errMsg = (res && res.message) ? res.message : JSON.stringify(res);
      scanInfo.innerText = 'การส่งข้อมูลไม่สำเร็จ: ' + errMsg;
      // keep scannerCard visible so user can retry
    }
  } catch (err) {
    console.error(err);
    scanInfo.innerText = 'เกิดข้อผิดพลาดในการส่งข้อมูล: ' + (err.message || err);
  }
});

/* new scan button */
newScanBtn.addEventListener('click', () => {
  // reset and return to form
  hide(successCard);
  show(formCard);
  // keep previous name/phone for convenience
});

/* helpful: close modal if user taps outside (bottom sheet) */
confirmModal.addEventListener('click', (ev) => {
  if (ev.target === confirmModal) {
    // do nothing: force user to choose
  }
});

/* On page unload stop camera */
window.addEventListener('beforeunload', () => {
  stopScanner();
});
</script>
</body>
</html>
