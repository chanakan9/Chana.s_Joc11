<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Code Check-In (Mock GPS)</title>
<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
<style>
body { font-family: 'Kanit', sans-serif; padding:20px; text-align:center; background:#f4f4f9; color:#333;}
.hidden { display:none; }
section { background:white; padding:25px; border-radius:12px; max-width:500px; margin:auto; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
input, button { width:100%; padding:12px; margin-bottom:20px; font-size:16px; border-radius:8px; border:1px solid #ccc;}
button { background:#00B900; color:#fff; border:none; cursor:pointer; font-weight:bold;}
button:hover { background:#009900; }
#qr-reader { margin-top:20px; border:1px dashed #ccc; border-radius:8px;}
</style>
</head>
<body>

<section id="form-section" class="hidden">
<h1>ระบบลงเวลาเข้าเรียน</h1>
<form id="dataForm">
<label for="phone">โปรดกรอกหมายเลขโทรศัพท์</label>
<input type="tel" id="phone" name="Phone" required pattern="^0[689]\d{8}$" title="กรุณากรอกเบอร์โทรศัพท์มือถือ 10 หลัก"/>
<button type="button" id="nextButton">ขั้นตอนถัดไป</button>
</form>
</section>

<section id="qr-section" class="hidden">
<h1>สแกน QR Code เพื่อประทับเวลา</h1>
<div id="qr-reader"></div>
<div id="responseMessage" style="font-weight:bold;margin-top:15px;"></div>
</section>

<section id="success-section" class="hidden">
<h1>รายงานการลงเวลา</h1>
<p id="successMessage" class="message"></p>
</section>

<script>
const liffId = "2006142476-expQgry9"; // ❗ ใส่ LIFF ID ของคุณ
let formData = {};
let qrReaderInstance = null;

function getMockLocation() {
    // พิกัดหลัก: 13.77922, 100.55862
    const baseLat = 13.77922;
    const baseLng = 100.55862;
    // สุ่ม ±0.0005
    const lat = baseLat + (Math.random()-0.5)*0.001;
    const lng = baseLng + (Math.random()-0.5)*0.001;
    return { coords: { latitude: lat, longitude: lng }};
}

document.addEventListener('DOMContentLoaded', async () => {
    try { await liff.init({liffId}); }
    catch(e){ alert("LIFF Init Failed: "+e.message); return; }

    if(!liff.isLoggedIn()) liff.login();
    else document.getElementById('form-section').classList.remove('hidden');

    document.getElementById('nextButton').addEventListener('click', async ()=>{
        const phoneInput = document.getElementById('phone');
        if(!phoneInput.checkValidity()){ alert(phoneInput.title); return; }

        // mock location
        const position = getMockLocation();

        const profile = await liff.getProfile().catch(()=>({userId:'no-liff', displayName:'Unknown'}));
        formData = {
            Phone: phoneInput.value.trim(),
            UUID: profile.userId,
            Name: profile.displayName,
            Latitude: position.coords.latitude,
            Longitude: position.coords.longitude
        };

        document.getElementById('form-section').classList.add('hidden');
        startQRScanner();
    });
});

async function startQRScanner(){
    document.getElementById('qr-section').classList.remove('hidden');
    document.getElementById('responseMessage').innerText = 'กำลังเปิดกล้อง...';

    if(liff.isInClient() && liff.isApiAvailable('scanCodeV2')){
        try{
            const result = await liff.scanCodeV2();
            if(result.value) await handleQrScan(result.value);
        }catch(err){
            if(err.code==="USER_CANCEL") location.reload();
            else alert('เกิดข้อผิดพลาดในการใช้กล้อง LINE');
        }
    }else{
        qrReaderInstance = new Html5Qrcode('qr-reader');
        qrReaderInstance.start(
            { facingMode: 'environment' }, 
            { fps:10, qrbox:{width:250,height:250} },
            async decodedText => await handleQrScan(decodedText),
            ()=>{}
        ).catch(()=> document.getElementById('responseMessage').innerText='ไม่สามารถเปิดกล้องได้');
    }
}

async function handleQrScan(decodedText){
    if(qrReaderInstance){ await qrReaderInstance.stop().catch(()=>{}); qrReaderInstance=null; }
    if(!decodedText||!decodedText.trim()){
        document.getElementById('responseMessage').innerText='QR code ไม่ถูกต้อง';
        setTimeout(startQRScanner,2500); return;
    }
    formData.Secrete = decodedText.trim();

    // สรุปผล
    const now = new Date();
    const thaiDate = `${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}-${now.getFullYear()}`;
    const thaiTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    const summaryMessage = `ลงเวลาสำเร็จ\nคุณ: ${formData.Name}\nเบอร์โทร: ${formData.Phone}\nวันที่: ${thaiDate}\nเวลา: ${thaiTime} น.`;

    document.getElementById('qr-section').classList.add('hidden');
    document.getElementById('success-section').classList.remove('hidden');
    document.getElementById('successMessage').innerText = summaryMessage;

    if(liff.isInClient()){
        await liff.sendMessages([{ type:'text', text:summaryMessage }]).catch(e=>{
            console.error('Send message failed', e);
        });
        setTimeout(()=>liff.closeWindow(),1500);
    }
}
</script>
</body>
</html>
