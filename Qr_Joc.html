<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR Code Check-In (No LIFF)</title>

<!-- html5-qrcode (camera scanner) -->
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">

<style>
  :root{--green:#00B900;--red:#f44336}
  body{font-family:'Kanit',sans-serif;margin:0;padding:20px;background:#f4f4f9;color:#222;display:flex;flex-direction:column;align-items:center}
  header img{width:80px;margin-bottom:14px}
  section{background:#fff;padding:22px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);width:100%;max-width:540px;box-sizing:border-box;margin-bottom:16px}
  h1{margin:0 0 8px;font-size:20px}
  p.lead{margin:0 0 14px;color:#666}
  label{display:block;margin-bottom:8px;font-weight:600}
  input,button,select{width:100%;padding:12px;border-radius:8px;border:1px solid #dcdcdc;box-sizing:border-box;font-size:16px}
  button{background:var(--green);color:#fff;border:none;cursor:pointer;font-weight:700}
  button.secondary{background:#fff;color:var(--green);border:2px solid var(--green)}
  button.danger{background:var(--red)}
  .message{margin-top:10px;font-weight:600;color:#333}
  #qr-reader{margin-top:14px;border:1px dashed #ccc;border-radius:8px;min-height:260px}
  .hidden{display:none !important}
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.55);display:flex;align-items:flex-end;justify-content:center;padding:18px;z-index:999}
  .modal .card{background:#fff;border-radius:14px;padding:18px;width:100%;max-width:540px;box-sizing:border-box}
  .modal h2{margin:0 0 12px;font-size:20px;text-align:center}
  .modal .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
  .progress-bar{height:14px;background:#e9e9e9;border-radius:8px;overflow:hidden}
  .progress-bar > div{height:100%;width:0%;background:var(--green);transition:width .4s}
  pre.debug{background:#f7f7f7;padding:10px;border-radius:8px;white-space:pre-wrap;word-break:break-word;margin-top:12px}
  .small-note{font-size:12px;color:#666;margin-top:8px}
  .btn-row{display:flex;gap:12px}
  .btn-row button{flex:1}
  /* make modal not focus-trap when hidden */
  .modal[aria-hidden="true"]{display:none}
</style>
</head>
<body>

<header>
  <img src="https://drive.google.com/thumbnail?id=1biw0LeK_X0ntKPdH4-8XaPUcl1yGDl59" alt="Logo">
</header>

<!-- Form -->
<section id="form-section">
  <h1>ระบบลงเวลาเข้าเรียน</h1>
  <p class="lead">ณ สศท.สปท.</p>

  <label for="nameInput">ชื่อ (ระบุชื่อ/รหัส)</label>
  <input id="nameInput" type="text" placeholder="เช่น B105 Chana.s" autocomplete="name" />

  <label for="phoneInput">หมายเลขโทรศัพท์</label>
  <input id="phoneInput" type="tel" placeholder="08xxxxxxxx" pattern="^0[689]\d{8}$" />

  <div class="btn-row" style="margin-top:12px">
    <button id="startScanBtn">เริ่มสแกน QR</button>
    <button id="stopAllBtn" class="secondary" type="button">ยกเลิก</button>
  </div>

  <div class="small-note">ตำแหน่งจะถูกสุ่มภายใน 5–10 เมตรจากตำแหน่งฐาน (13.77922,100.55861) **เมื่อสแกนเสร็จและก่อนส่งข้อมูล**</div>
</section>

<!-- Scanner section -->
<section id="qr-section" class="hidden">
  <h1>แสกน QR Code เพื่อประทับเวลา</h1>
  <div id="qr-reader" aria-label="QR camera area"></div>
  <div id="responseMessage" class="message"></div>

  <div class="btn-row" style="margin-top:12px">
    <button id="stopScanBtn" class="danger">หยุดสแกน</button>
    <button id="retryScanBtn" class="hidden">สแกนใหม่</button>
  </div>
</section>

<!-- Modal: summary & confirm -->
<div id="summaryModal" class="modal" aria-hidden="true">
  <div class="card" role="dialog" aria-modal="true" aria-labelledby="summaryTitle">
    <h2 id="summaryTitle">สรุปผลการสแกน</h2>
    <div id="summaryBody" style="line-height:1.6;color:#222"></div>

    <div class="grid" style="margin-top:12px">
      <button id="scanAgainBtn" class="danger">สแกนใหม่</button>
      <button id="confirmSendBtn">ยืนยันและส่งข้อมูล</button>
    </div>

    <div class="progress-bar hidden" id="progressContainer" style="margin-top:14px"><div id="progressBarInner"></div></div>
    <pre class="debug hidden" id="debugBox"></pre>
    <div style="height:8px"></div>
  </div>
</div>

<!-- Success section -->
<section id="success-section" class="hidden">
  <h1>รายงานการลงเวลา</h1>
  <p id="successMessage" class="message"></p>
  <button id="newEntryBtn" style="margin-top:10px">ลงเวลาใหม่</button>
</section>

<script>
/*
  Fixed & improved version:
  - Randomize mock GPS only after successful scan (before sending)
  - Removed visible "สุ่มตำแหน่ง" button from UI
  - Modal hidden by aria-hidden & class; only shows when needed
  - Buttons disabled during send
*/

const scriptURL = 'https://script.google.com/macros/s/AKfycby8iE0HQ4V_8rgjHNalxp1bM4VFxxz5JBXkUc0qpqkLxcYxM1iE5vmhQO0wCoNG1eIfCg/exec';
const baseLat = 13.77922;
const baseLng = 100.55861;

/* ========== helpers ========== */
function randomLocationMeters(minMeters = 5, maxMeters = 10) {
  const meterToDeg = 1 / 111111;
  const distance = Math.random() * (maxMeters - minMeters) + minMeters;
  const angle = Math.random() * 2 * Math.PI;
  const dLat = (distance * Math.cos(angle)) * meterToDeg;
  const dLng = (distance * Math.sin(angle)) * (meterToDeg / Math.cos(baseLat * Math.PI / 180));
  return { latitude: baseLat + dLat, longitude: baseLng + dLng };
}

function formatThaiDateTime(d = new Date()) {
  const day = String(d.getDate()).padStart(2,'0');
  const month = String(d.getMonth()+1).padStart(2,'0');
  const year = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return { date:`${day}-${month}-${year}`, time:`${hh}:${mm}` };
}

/* JSONP call to GAS (returns Promise) */
function callApi(action, params={}) {
  return new Promise((resolve, reject) => {
    const callbackName = `jsonp_cb_${Date.now()}_${Math.floor(Math.random()*9999)}`;
    window[callbackName] = (res) => {
      delete window[callbackName];
      script.remove();
      resolve(res);
    };
    const url = new URL(scriptURL);
    url.searchParams.append('action', action);
    for (const k in params) {
      url.searchParams.append(k, params[k]);
    }
    url.searchParams.append('callback', callbackName);
    const script = document.createElement('script');
    script.src = url.toString();
    script.onerror = () => {
      delete window[callbackName];
      script.remove();
      reject(new Error('API network/script load error'));
    };
    document.body.appendChild(script);
  });
}

/* ========== DOM ========== */
const nameInput = document.getElementById('nameInput');
const phoneInput = document.getElementById('phoneInput');
const startScanBtn = document.getElementById('startScanBtn');

const formSection = document.getElementById('form-section');
const qrSection = document.getElementById('qr-section');
const successSection = document.getElementById('success-section');

const qrReaderElem = document.getElementById('qr-reader');
const responseMessage = document.getElementById('responseMessage');
const stopScanBtn = document.getElementById('stopScanBtn');
const retryScanBtn = document.getElementById('retryScanBtn');

const summaryModal = document.getElementById('summaryModal');
const summaryBody = document.getElementById('summaryBody');
const scanAgainBtn = document.getElementById('scanAgainBtn');
const confirmSendBtn = document.getElementById('confirmSendBtn');

const progressContainer = document.getElementById('progressContainer');
const progressInner = document.getElementById('progressBarInner');
const debugBox = document.getElementById('debugBox');

const successMessage = document.getElementById('successMessage');
const newEntryBtn = document.getElementById('newEntryBtn');

const stopAllBtn = document.getElementById('stopAllBtn');

/* ========== state ========== */
let html5QrScanner = null;
let lastFormData = null; // object to send (not yet randomized pos)
let lastMockPos = null;

/* ========== UI helpers ========== */
function showSection(id) {
  formSection.classList.toggle('hidden', id !== 'form');
  qrSection.classList.toggle('hidden', id !== 'qr');
  successSection.classList.toggle('hidden', id !== 'success');
}

function showSummaryModal(show=true) {
  summaryModal.setAttribute('aria-hidden', show? 'false' : 'true');
  summaryModal.classList.toggle('hidden', !show);
  // prevent body scroll when modal open
  document.body.style.overflow = show ? 'hidden' : '';
}

function setProgress(pct) {
  progressContainer.classList.remove('hidden');
  progressInner.style.width = `${pct}%`;
}

/* ========== scanner control ========== */
async function startQRScanner() {
  responseMessage.innerText = '';
  retryScanBtn.classList.add('hidden');
  showSection('qr');

  // clear qr-reader content
  qrReaderElem.innerHTML = '';

  html5QrScanner = new Html5Qrcode(/* element id */ "qr-reader", /* verbose= */ false);
  const config = { fps: 10, qrbox: { width: 250, height: 250 } };

  try {
    await html5QrScanner.start(
      { facingMode: "environment" },
      config,
      qrSuccessCallback,
      (err) => {
        // optional per-frame error callback (ignored)
      }
    );
  } catch (err) {
    responseMessage.innerText = 'ไม่สามารถเปิดกล้องได้ หรืออุปกรณ์ไม่รองรับ';
    retryScanBtn.classList.remove('hidden');
  }
}

async function stopQRScanner() {
  if (html5QrScanner) {
    try { await html5QrScanner.stop(); } catch(e){}
    try { html5QrScanner.clear(); } catch(e){}
    html5QrScanner = null;
  }
}

/* ========== scan result handler ========== */
async function qrSuccessCallback(decodedText) {
  // Stop scanning immediately to avoid duplicate scans
  await stopQRScanner();

  if (!decodedText || !decodedText.trim()) {
    responseMessage.innerText = 'QR code ไม่ถูกต้อง โปรดสแกนอีกครั้ง';
    retryScanBtn.classList.remove('hidden');
    return;
  }

  // collect form fields
  const nameVal = nameInput.value.trim() || 'ไม่ระบุ';
  const phoneVal = phoneInput.value.trim() || '';

  // basic phone validation (allow empty)
  if (phoneVal && !/^0[689]\d{8}$/.test(phoneVal)) {
    responseMessage.innerText = 'หมายเลขโทรศัพท์ไม่ถูกต้อง (รูปแบบ 0x...)';
    retryScanBtn.classList.remove('hidden');
    return;
  }

  // prepare payload WITHOUT position yet
  const payload = {
    Name: nameVal,
    Phone: phoneVal,
    Secrete: decodedText.trim(),
    Latitude: null,
    Longitude: null,
    UUID: `no-liff-${cryptoRandomId()}`
  };

  lastFormData = payload;

  // Build and show summary modal (position will be randomized when Confirm pressed)
  const now = new Date();
  const { date, time } = formatThaiDateTime(now);
  const summaryText = `
ลงเวลาพร้อมส่ง
--------------------
คุณ: ${payload.Name}
เบอร์โทร: ${payload.Phone || 'N/A'}
วันที่: ${date}
เวลา: ${time} น.
(ตำแหน่งจะถูกสุ่มก่อนส่งข้อมูล)
  `.trim();

  summaryBody.innerText = summaryText;
  showSummaryModal(true);
}

/* ========== confirm & send ========== */
scanAgainBtn.addEventListener('click', async ()=> {
  showSummaryModal(false);
  lastMockPos = null;
  lastFormData = null;
  responseMessage.innerText = '';
  await startQRScanner();
});

confirmSendBtn.addEventListener('click', async ()=> {
  if (!lastFormData) return;
  // disable buttons while sending
  confirmSendBtn.disabled = true;
  scanAgainBtn.disabled = true;
  setProgress(5);
  debugBox.classList.add('hidden');
  progressContainer.classList.remove('hidden');

  try {
    // Before sending, randomize position (only now)
    lastMockPos = randomLocationMeters();
    lastFormData.Latitude = lastMockPos.latitude;
    lastFormData.Longitude = lastMockPos.longitude;

    // Step 1: add
    summaryBody.innerText = 'ขั้นตอน 1/3: กำลังส่งข้อมูลเพื่อบันทึก...';
    const addRes = await callApi('add', { text: JSON.stringify(lastFormData) });
    setProgress(35);

    if (!addRes || addRes.status !== 'added') {
      throw addRes || new Error('add failed');
    }

    // Step 2: short processing wait (server-side)
    summaryBody.innerText = 'ขั้นตอน 2/3: บันทึกสำเร็จ! กำลังรอเพื่อตรวจสอบ...';
    await new Promise(r => setTimeout(r, 900));
    setProgress(60);

    // Step 3: check
    summaryBody.innerText = 'ขั้นตอน 3/3: กำลังดึงข้อมูลมาเปรียบเทียบ...';
    const checkParams = {
      name: addRes.nameForCheck || lastFormData.Name || '',
      date: addRes.dateForCheck || '',
      secrete: addRes.secreteForCheck || lastFormData.Secrete || ''
    };
    const checkRes = await callApi('check', checkParams);
    setProgress(100);

    if (checkRes && checkRes.status === 'found') {
      // success - hide modal and show success section
      summaryBody.innerText = '✅ ตรวจสอบข้อมูลถูกต้อง! ส่งข้อมูลสำเร็จแล้ว';
      showSummaryModal(false);

      successMessage.innerText = `ลงเวลาสำเร็จ!\nคุณ: ${lastFormData.Name}\nเบอร์โทร: ${lastFormData.Phone || 'N/A'}\nเวลา: ${formatThaiDateTime().time} น.`;
      showSection('success');
    } else {
      const errMsg = (checkRes && checkRes.message) ? (checkRes.message) : 'การตรวจสอบไม่พบข้อมูล';
      showSummaryModal(false);
      responseMessage.innerText = `ตรวจสอบข้อมูลล้มเหลว: ${errMsg}`;
      retryScanBtn.classList.remove('hidden');
      debugBox.classList.remove('hidden');
      debugBox.innerText = JSON.stringify({ addRes, checkRes }, null, 2);
    }
  } catch (err) {
    console.error('send error', err);
    showSummaryModal(false);
    responseMessage.innerText = `เกิดข้อผิดพลาดในการส่ง: ${err && err.message ? err.message : JSON.stringify(err)}`;
    retryScanBtn.classList.remove('hidden');
    debugBox.classList.remove('hidden');
    debugBox.innerText = typeof err === 'object' ? JSON.stringify(err, null, 2) : String(err);
  } finally {
    confirmSendBtn.disabled = false;
    scanAgainBtn.disabled = false;
    progressInner.style.width = '0%';
    progressContainer.classList.add('hidden');
    setProgress(0);
  }
});

/* ========== UI events ========== */
startScanBtn.addEventListener('click', async () => {
  const nameVal = nameInput.value.trim();
  if (!nameVal) {
    if (!confirm('คุณยังไม่ได้กรอกชื่อ จะดำเนินการต่อโดยใช้ชื่อ "ไม่ระบุ" หรือไม่?')) return;
  }
  responseMessage.innerText = '';
  lastMockPos = null; // ensure randomization happens later
  await startQRScanner();
});

stopScanBtn.addEventListener('click', async () => {
  await stopQRScanner();
  showSection('form');
});

retryScanBtn.addEventListener('click', async () => {
  responseMessage.innerText = '';
  retryScanBtn.classList.add('hidden');
  lastFormData = null;
  lastMockPos = null;
  await startQRScanner();
});

newEntryBtn.addEventListener('click', () => {
  // reset for new usage
  nameInput.value = '';
  phoneInput.value = '';
  lastFormData = null;
  lastMockPos = null;
  responseMessage.innerText = '';
  showSection('form');
});

stopAllBtn.addEventListener('click', async () => {
  // a simple cancel button on form (not required)
  await stopQRScanner();
  lastFormData = null;
  lastMockPos = null;
  responseMessage.innerText = '';
  showSection('form');
});

/* small util: crypto id */
function cryptoRandomId() {
  if (window.crypto && crypto.getRandomValues) {
    const a = new Uint32Array(4);
    crypto.getRandomValues(a);
    return Array.from(a, n => n.toString(16)).join('-');
  } else {
    return Math.random().toString(36).slice(2);
  }
}

/* init */
showSection('form');
</script>
</body>
</html>
