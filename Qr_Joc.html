<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scan with Fake GPS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 15px; font-family: sans-serif; }
        section { display: none; margin-top: 20px; }
        section.active { display: block; }
        #progressBarContainer { width: 100%; background-color: #eee; margin: 10px 0; height: 20px; border-radius: 10px; overflow: hidden; }
        #progressBar { height: 100%; width: 0%; background-color: #4caf50; transition: width 0.3s; }
        .hidden { display: none; }
        .comparison-container { margin-top: 10px; }
        .mismatch { color: red; }
        .match { color: green; }
        #phoneConfirmModal, #scanSummaryModal { display: none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }
        #success-section { text-align: center; margin-top: 20px; }
    </style>
</head>
<body>
    <h2 id="header" class="hidden">ระบบสแกน QR</h2>
    <div id="loading-message">กำลังโหลด...</div>

    <section id="form-section">
        <div class="mb-3">
            <label for="phone" class="form-label">เบอร์โทร</label>
            <input type="tel" class="form-control" id="phone" placeholder="0812345678" required title="กรุณากรอกเบอร์โทร">
        </div>
        <button id="nextButton" class="btn btn-primary">ต่อไป</button>
    </section>

    <section id="qr-section">
        <div id="qr-reader" style="width:100%; max-width:400px; margin:auto;"></div>
        <div id="responseMessage" class="mt-2"></div>
        <div id="progressBarContainer" class="hidden">
            <div id="progressBar"></div>
        </div>
        <div id="progress-steps" class="hidden"></div>
        <div id="comparison-details" class="hidden"></div>
        <button id="retryScanButton" class="btn btn-warning hidden">ลองใหม่</button>
    </section>

    <section id="success-section">
        <h3 id="successMessage"></h3>
    </section>

    <!-- Modal เบอร์โทร -->
    <div id="phoneConfirmModal">
        <div class="modal-content text-center">
            <p>คุณยืนยันเบอร์นี้ใช่หรือไม่?</p>
            <p id="phoneDisplay" style="font-weight:bold;"></p>
            <button id="confirmPhoneButton" class="btn btn-success">ยืนยัน</button>
            <button id="cancelPhoneButton" class="btn btn-secondary">ยกเลิก</button>
        </div>
    </div>

    <!-- Modal สรุป QR -->
    <div id="scanSummaryModal">
        <div class="modal-content text-center">
            <pre id="summaryText"></pre>
            <button id="confirmScanButton" class="btn btn-success">ยืนยัน</button>
            <button id="cancelScanButton" class="btn btn-secondary">สแกนใหม่</button>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const liffId = "YOUR_LIFF_ID"; // <-- ใส่ LIFF ID ของคุณ
        const scriptURL = "YOUR_GAS_SCRIPT_URL"; // <-- ใส่ URL Google Apps Script
        let qrReaderInstance = null;
        let formData = {};
        let summaryMessageForLiff = "";

        const loadingMessage = document.getElementById('loading-message');
        const header = document.getElementById('header');
        const phoneModal = document.getElementById('phoneConfirmModal');
        const scanSummaryModal = document.getElementById('scanSummaryModal');
        const responseMessage = document.getElementById('responseMessage');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const progressSteps = document.getElementById('progress-steps');
        const comparisonDetails = document.getElementById('comparison-details');
        const retryScanButton = document.getElementById('retryScanButton');

        async function main() {
            try {
                await liff.init({ liffId });
            } catch (err) {
                console.error("LIFF init error:", err);
                loadingMessage.innerText = "เกิดข้อผิดพลาดในการเริ่มต้น LIFF";
                return;
            }

            // Login LINE ทุกครั้ง
            liff.login({ redirectUri: window.location.href });
        }

        async function getDeviceInfo() {
            let deviceUUID, displayName = "Unknown";
            try {
                const profile = await liff.getProfile();
                deviceUUID = profile.userId;
                displayName = profile.displayName;
            } catch (e) {
                deviceUUID = `no-liff-${crypto.randomUUID()}`;
            }
            return { uuid: deviceUUID, displayName: displayName };
        }

        // ฟังก์ชัน GPS ปลอม
        function getFakeLocation() {
            const baseLat = 13.77922;
            const baseLng = 100.55862;
            const offset = 0.0003;
            const lat = baseLat + (Math.random() - 0.5) * offset;
            const lng = baseLng + (Math.random() - 0.5) * offset;
            return { latitude: lat, longitude: lng };
        }

        const showSection = (sectionId) => {
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        };

        function callApi(action, params) {
            return new Promise((resolve, reject) => {
                const callbackName = `jsonpCallback_${Date.now()}${Math.floor(Math.random()*1000)}`;
                window[callbackName] = (result) => {
                    delete window[callbackName];
                    document.body.removeChild(scriptEl);
                    resolve(result);
                };
                const url = new URL(scriptURL);
                url.searchParams.append('action', action);
                for(const key in params) url.searchParams.append(key, params[key]);
                url.searchParams.append('callback', callbackName);
                const scriptEl = document.createElement('script');
                scriptEl.src = url.toString();
                scriptEl.onerror = () => { delete window[callbackName]; document.body.removeChild(scriptEl); reject(new Error("API failed")); };
                document.body.appendChild(scriptEl);
            });
        }

        async function handleQrScan(decodedText) {
            if (qrReaderInstance) {
                await qrReaderInstance.stop().catch(()=>{});
                qrReaderInstance = null;
            }
            if (!decodedText || !decodedText.trim()) {
                responseMessage.innerText = 'QR code ไม่ถูกต้อง โปรดสแกนใหม่';
                setTimeout(startQRScanner, 2000);
                return;
            }
            formData.Secrete = decodedText.trim();
            const now = new Date();
            const thaiDate = `${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}-${now.getFullYear()}`;
            const thaiTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            summaryMessageForLiff = `ลงเวลาสำเร็จ\nคุณ: ${formData.Name}\nเบอร์โทร: ${formData.Phone}\nวันที่: ${thaiDate}\nเวลา: ${thaiTime} น.`;
            document.getElementById('summaryText').innerText = summaryMessageForLiff;
            scanSummaryModal.style.display = 'flex';
            showSection('qr-section');
        }

        async function proceedWithSubmission() {
            scanSummaryModal.style.display = 'none';
            responseMessage.innerText = 'กรุณารอสักครู่...';
            progressBar.style.width = '0%';
            progressBarContainer.classList.remove('hidden');
            progressSteps.classList.remove('hidden');
            comparisonDetails.classList.add('hidden');
            retryScanButton.classList.add('hidden');

            try {
                progressSteps.innerText = 'ขั้นตอนที่ 1/3: กำลังส่งข้อมูล...';
                progressBar.style.width = '10%';
                const addResult = await callApi('add',{text:JSON.stringify(formData)});
                if(addResult.status!=='added') throw addResult;
                progressBar.style.width='33%';
                progressSteps.innerText='ขั้นตอนที่ 2/3: บันทึกสำเร็จ! รอตรวจสอบ...';
                await new Promise(r=>setTimeout(r,2000));
                progressBar.style.width='66%';
                progressSteps.innerText='ขั้นตอนที่ 3/3: ตรวจสอบข้อมูล...';
                const checkResult = await callApi('check',{name:addResult.nameForCheck,date:addResult.dateForCheck,secrete:addResult.secreteForCheck});
                progressBar.style.width='100%';
                if(checkResult.status==='found') await showSuccessAndSendMessage();
                else throw checkResult;
            } catch(e){
                console.error(e);
                progressBarContainer.classList.add('hidden');
                progressSteps.classList.add('hidden');
                responseMessage.innerText='';
                comparisonDetails.innerHTML=`<div class="comparison-container"><h4>เกิดข้อผิดพลาด</h4><p>${e.message||'ล้มเหลว'}</p></div>`;
                comparisonDetails.classList.remove('hidden');
                retryScanButton.classList.remove('hidden');
            }
        }

        async function showSuccessAndSendMessage() {
            showSection('success-section');
            document.getElementById('successMessage').innerText='ตรวจสอบข้อมูลสำเร็จ! กำลังส่งข้อความ...';
            if(liff.isInClient()){
                try{
                    await liff.sendMessages([{type:'text',text:summaryMessageForLiff}]);
                    document.getElementById('successMessage').innerText='ส่งข้อความสำเร็จ! ปิดหน้าต่างใน 2 วินาที';
                    setTimeout(()=>liff.closeWindow(),1500);
                }catch(err){
                    document.getElementById('successMessage').innerText=`เกิดข้อผิดพลาด: ${err.message}`;
                }
            } else {
                document.getElementById('successMessage').innerText=`ลงเวลาสำเร็จ (อยู่นอก LINE)\n\n${summaryMessageForLiff}`;
            }
        }

        async function startQRScanner() {
            responseMessage.innerText='';
            progressBarContainer.classList.add('hidden');
            progressSteps.classList.add('hidden');
            comparisonDetails.classList.add('hidden');
            retryScanButton.classList.add('hidden');
            progressBar.style.width='0%';
            showSection('qr-section');
            document.getElementById('qr-reader').innerHTML='';

            if(liff.isInClient() && liff.isApiAvailable('scanCodeV2')){
                try{
                    const result = await liff.scanCodeV2();
                    if(result.value) await handleQrScan(result.value);
                }catch(err){
                    if(err.code==="USER_CANCEL") showSection('form-section');
                    else alert('เกิดข้อผิดพลาดในการใช้กล้อง LINE');
                }
            } else {
                responseMessage.innerText='กำลังเปิดกล้อง...';
                qrReaderInstance = new Html5Qrcode('qr-reader');
                qrReaderInstance.start({facingMode:'environment'},{fps:10,qrbox:{width:250,height:250}},handleQrScan,()=>{}).catch(()=>{responseMessage.innerText='ไม่สามารถเปิดกล้องได้';});
            }
        }

        document.getElementById('nextButton').addEventListener('click',()=>{
            const phoneInput = document.getElementById('phone');
            if(!phoneInput.checkValidity()){ alert(phoneInput.title); return; }
            document.getElementById('phoneDisplay').innerText=phoneInput.value;
            phoneModal.style.display='flex';
        });
        document.getElementById('confirmPhoneButton').addEventListener('click',async()=>{
            phoneModal.style.display='none';
            const deviceInfo = await getDeviceInfo();
            const fakePos = getFakeLocation();
            formData={Phone: document.getElementById('phone').value.trim(), UUID:deviceInfo.uuid, Name:deviceInfo.displayName, Latitude:fakePos.latitude, Longitude:fakePos.longitude};
            await startQRScanner();
        });
        document.getElementById('cancelPhoneButton').addEventListener('click',()=>phoneModal.style.display='none');
        document.getElementById('confirmScanButton').addEventListener('click',proceedWithSubmission);
        document.getElementById('cancelScanButton').addEventListener('click',()=>{scanSummaryModal.style.display='none'; startQRScanner();});
        retryScanButton.addEventListener('click',startQRScanner);

        main();
    </script>
</body>
</html>
