<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Code Check-In</title>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
<style>
body { font-family: 'Kanit', sans-serif; margin: 0; padding: 20px; text-align:center; background:#f4f4f9;}
.hidden { display: none; }
header img { width:80px; margin-bottom:20px;}
section { background:white; padding:25px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); max-width:500px; margin:0 auto;}
input, button { width:100%; padding:12px; margin-bottom:20px; border-radius:8px; font-size:16px;}
button { background:#00B900; color:#fff; border:none; font-weight:bold; cursor:pointer;}
button:hover { background:#009900;}
#qr-reader { margin-top:20px; border:1px dashed #ccc; border-radius:8px;}
.message { margin-top:15px; font-weight:bold; color:#555;}
/* Modal */
.modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; overflow:auto; background: rgba(0,0,0,0.5); }
.modal-content { background:white; margin:15% auto; padding:20px; border-radius:12px; width:90%; max-width:400px; text-align:left; }
.modal button { width:auto; margin:5px 5px 0 0; padding:10px 20px;}
</style>
</head>
<body>

<header>
<img src="https://drive.google.com/thumbnail?id=1biw0LeK_X0ntKPdH4-8XaPUcl1yGDl59" alt="Logo"/>
</header>

<!-- ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ -->
<section id="form-section">
<h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
<p>‡∏ì ‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó.</p>
<form id="dataForm">
<label for="phone">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
<input type="tel" id="phone" name="Phone" required pattern="^0[689]\d{8}$" title="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ 10 ‡∏´‡∏•‡∏±‡∏Å">
<button type="button" id="nextButton">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
</form>
</section>

<!-- ‡∏™‡πÅ‡∏Å‡∏ô QR -->
<section id="qr-section" class="hidden">
<h1>‡πÅ‡∏™‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</h1>
<div id="qr-reader"></div>
<div class="message" id="responseMessage"></div>
<button id="retryScanButton" class="hidden">‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
</section>

<!-- ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -->
<section id="success-section" class="hidden">
<h1>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h1>
<p class="message" id="successMessage"></p>
</section>

<!-- Modal ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á -->
<div id="scanSummaryModal" class="modal">
  <div class="modal-content">
    <h3>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á</h3>
    <p id="summaryText"></p>
    <button id="confirmScanButton">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á</button>
    <button id="cancelScanButton">‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
  </div>
</div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycby8iE0HQ4V_8rgjHNalxp1bM4VFxxz5JBXkUc0qpqkLxcYxM1iE5vmhQO0wCoNG1eIfCg/exec';

let formData = {};
let qrReaderInstance = null;
const scanSummaryModal = document.getElementById('scanSummaryModal');
const responseMessage = document.getElementById('responseMessage');
const retryScanButton = document.getElementById('retryScanButton');

/* =========================================================
   ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ 5‚Äì10 ‡πÄ‡∏°‡∏ï‡∏£ ‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏´‡∏•‡∏±‡∏Å
========================================================= */
function randomLocation() {
  const baseLat = 13.77922;
  const baseLng = 100.55861;
  const meterToDeg = 1 / 111111;
  const min = 5;
  const max = 10;
  const distance = Math.random() * (max - min) + min;
  const angle = Math.random() * 2 * Math.PI;
  const dLat = (distance * Math.cos(angle)) * meterToDeg;
  const dLng = (distance * Math.sin(angle)) * (meterToDeg / Math.cos(baseLat * Math.PI / 180));
  return { latitude: baseLat + dLat, longitude: baseLng + dLng };
}

/* ========================================================= */
function showSection(id) {
  document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

async function callApi(action, params) {
  const callbackName = `jsonpCallback_${Date.now()}`;
  return new Promise((resolve,reject)=>{
    window[callbackName] = (res)=>{delete window[callbackName]; document.body.removeChild(scriptEl); resolve(res);};
    const url = new URL(scriptURL);
    url.searchParams.append('action', action);
    for(const k in params) url.searchParams.append(k, params[k]);
    url.searchParams.append('callback', callbackName);
    const scriptEl = document.createElement('script');
    scriptEl.src = url.toString();
    scriptEl.onerror = ()=>{delete window[callbackName]; document.body.removeChild(scriptEl); reject("API call failed");};
    document.body.appendChild(scriptEl);
  });
}

/* =========================================================
   ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
========================================================= */
async function handleQrScan(decodedText){
  if(qrReaderInstance){ await qrReaderInstance.stop().catch(()=>{}); qrReaderInstance=null;}
  if(!decodedText || !decodedText.trim()){
    responseMessage.innerText='QR code ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
    startQRScanner();
    return;
  }

  const phone = document.getElementById('phone').value.trim();
  const mockPos = randomLocation();

  formData = {
    Phone: phone,
    Secrete: decodedText.trim(),
    Latitude: mockPos.latitude,
    Longitude: mockPos.longitude
  };

  // ‡πÅ‡∏™‡∏î‡∏á modal ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  const now = new Date();
  const thaiDate = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
  const thaiTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  document.getElementById('summaryText').innerText =
    `üìå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${thaiDate}\n‚è± ‡πÄ‡∏ß‡∏•‡∏≤: ${thaiTime}\nüî¢ QR: ${decodedText.trim()}`;
  scanSummaryModal.style.display = "flex";
}

/* =========================================================
   ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
========================================================= */
document.getElementById('confirmScanButton').addEventListener('click', async ()=>{
  scanSummaryModal.style.display = "none";
  responseMessage.innerText='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

  try{
    const result = await callApi('add', {text: JSON.stringify(formData)});
    if(result.status==='added'){
      document.getElementById('successMessage').innerText='‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö LINE OA ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
      showSection('success-section');
    } else throw result;
  } catch(e){
    responseMessage.innerText='‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    retryScanButton.classList.remove('hidden');
  }
});

document.getElementById('cancelScanButton').addEventListener('click', ()=>{
  scanSummaryModal.style.display = "none";
  startQRScanner();
});

/* =========================================================
   ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô QR
========================================================= */
async function startQRScanner(){
  responseMessage.innerText='';
  retryScanButton.classList.add('hidden');
  showSection('qr-section');
  document.getElementById('qr-reader').innerHTML='';
  qrReaderInstance = new Html5Qrcode('qr-reader');
  qrReaderInstance.start(
    {facingMode:'environment'},
    {fps:10, qrbox:{width:250,height:250}},
    handleQrScan,
    ()=>{}
  ).catch(()=>{responseMessage.innerText='‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ';});
}

/* =========================================================
   ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
========================================================= */
document.getElementById('nextButton').addEventListener('click',()=>{
  const phoneInput = document.getElementById('phone');
  if(!phoneInput.checkValidity()){
    alert(phoneInput.title);
    return;
  }
  startQRScanner();
});

retryScanButton.addEventListener('click', startQRScanner);

/* =========================================================
   ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å
========================================================= */
window.onclick = function(event){
  if(event.target === scanSummaryModal) scanSummaryModal.style.display='none';
};
</script>
</body>
</html>
