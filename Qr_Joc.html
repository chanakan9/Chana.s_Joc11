<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QR Code Check-In (Real GAS)</title>

<!-- html5-qrcode -->
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>

<style>
  /* เบา ๆ ให้ UI ใกล้เคียงของเดิม */
  @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');
  body{font-family:'Kanit',sans-serif;background:#f4f4f9;margin:0;padding:18px;display:flex;justify-content:center}
  .card{width:100%;max-width:520px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
  header{display:flex;justify-content:center;margin-bottom:8px}
  header img{width:80px}
  h1{font-size:20px;margin:6px 0 12px}
  label{display:block;margin-top:8px;font-weight:700}
  input,button,select{width:100%;padding:12px;border:1px solid #d0d4db;border-radius:8px;box-sizing:border-box;font-size:15px}
  button{background:#00B900;color:#fff;border:none;font-weight:700;cursor:pointer;margin-top:12px}
  button.alt{background:#ff9800}
  .message{margin-top:12px;font-weight:600;color:#333}
  #qr-reader{margin-top:14px;border:1px dashed #ccc;border-radius:8px;min-height:260px;display:flex;align-items:center;justify-content:center}
  .hidden{display:none}
  .muted{color:#666;font-size:13px}
  .flex{display:flex;gap:8px}
  .flex > *{flex:1}
  .small{padding:8px;font-size:14px}
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:9999}
  .modal .box{background:#fff;padding:18px;border-radius:10px;width:90%;max-width:420px}
  pre{background:#f7f8fa;padding:10px;border-radius:6px;overflow:auto}
</style>
</head>
<body>
  <div class="card">
    <header><img src="https://drive.google.com/thumbnail?id=1biw0LeK_X0ntKPdH4-8XaPUcl1yGDl59" alt="Logo"></header>

    <h1>ระบบลงเวลาเข้าเรียน</h1>
    <p class="muted">ณ สศท.สปท.</p>

    <!-- ฟอร์ม: displayName (กรอก + แนะนำ), phone -->
    <label for="displayName">ชื่อ (ระบุชื่อ/รหัส — ผู้ใช้กรอกเอง)</label>
    <!-- datalist ให้เป็นตัวช่วยแนะนำ แต่ผู้ใช้ยังพิมพ์เองได้ -->
    <input id="displayName" list="nameSuggestions" placeholder="เช่น B105 Chana.s หรือใส่ชื่อของคุณ">
    <datalist id="nameSuggestions">
      <option value="B105 Chana.s"></option>
      <option value="B104 Somchai"></option>
      <option value="B106 Arisa"></option>
      <!-- คุณสามารถแก้/เพิ่มชื่อที่นี่ได้ -->
    </datalist>

    <label for="phone">หมายเลขโทรศัพท์</label>
    <input id="phone" type="tel" placeholder="08xxxxxxxx" pattern="^0[689]\d{8}$" title="กรุณากรอกเบอร์มือถือ 10 หลัก">

    <div class="flex" style="margin-top:6px">
      <button id="nextButton" class="small">ขั้นตอนถัดไป — เปิดสแกน</button>
      <button id="regenPos" class="small alt" title="สร้างพิกัดสุ่มใหม่">สุ่มพิกัดใหม่</button>
    </div>

    <div id="posInfo" class="muted" style="margin-top:8px">พิกัดสุ่ม: <span id="posDisplay">ยังไม่ได้สร้าง</span></div>

    <section id="qr-section" class="hidden">
      <h1 style="font-size:18px;margin-top:14px">แสกน QR Code เพื่อประทับเวลา</h1>
      <div id="qr-reader">กำลังรอเปิดกล้อง...</div>
      <div id="responseMessage" class="message"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="retryScanButton" class="hidden small">สแกนใหม่อีกครั้ง</button>
        <button id="stopScanButton" class="small">หยุดกล้อง</button>
      </div>
    </section>

    <section id="success-section" class="hidden">
      <h1 style="font-size:18px">รายงานการลงเวลา</h1>
      <p id="successMessage" class="message"></p>
      <pre id="rawResponse" class="hidden"></pre>
      <button id="newEntryBtn">ลงเวลาใหม่</button>
    </section>

    <div style="margin-top:12px" class="muted">หมายเหตุ: ข้อมูลจะถูกส่งจริงไปยังระบบเดิม (GAS) เมื่อยืนยัน.</div>
  </div>

  <!-- ยืนยัน ก่อนส่ง -->
  <div id="confirmModal" class="modal hidden">
    <div class="box">
      <h3>ยืนยันข้อมูลก่อนส่ง</h3>
      <div class="muted" style="margin-top:8px;white-space:pre-wrap" id="confirmText"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="cancelConfirm" class="small">ยกเลิก</button>
        <button id="sendConfirm" class="small">ยืนยันและส่ง</button>
      </div>
    </div>
  </div>

<script>
/* ================== ตั้งค่า GAS URL (ของระบบเดิม) ================== */
const GAS_URL = 'https://script.google.com/macros/s/AKfycby8iE0HQ4V_8rgjHNalxp1bM4VFxxz5JBXkUc0qpqkLxcYxM1iE5vmhQO0wCoNG1eIfCg/exec';

/* ================== ฟังก์ชันสุ่มพิกัด ±5–10 เมตร รอบฐาน ================== */
function randomLocation(baseLat=13.77922, baseLng=100.55861) {
  const meterToDeg = 1/111111; // approx
  const min = 5, max = 10;
  const d = Math.random()*(max-min) + min; // meters
  const angle = Math.random()*2*Math.PI;
  const dLat = (d * Math.cos(angle)) * meterToDeg;
  const dLng = (d * Math.sin(angle)) * (meterToDeg / Math.cos(baseLat * Math.PI/180));
  return { latitude: baseLat + dLat, longitude: baseLng + dLng, distanceMeters: d.toFixed(2) };
}

/* สร้างพิกัดเริ่มต้นเมื่อโหลดหน้า */
let currentMockPos = randomLocation();
document.getElementById('posDisplay').innerText = `${currentMockPos.latitude.toFixed(6)}, ${currentMockPos.longitude.toFixed(6)} (±${currentMockPos.distanceMeters} m)`;

/* ปุ่มสุ่มพิกัดใหม่ */
document.getElementById('regenPos').addEventListener('click', ()=>{
  currentMockPos = randomLocation();
  document.getElementById('posDisplay').innerText = `${currentMockPos.latitude.toFixed(6)}, ${currentMockPos.longitude.toFixed(6)} (±${currentMockPos.distanceMeters} m)`;
});

/* ================== ช่วยจัดการ Sections ================== */
function showSection(id) {
  document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

/* ================== JSONP helper สำหรับเรียก GAS ================== */
function callGAS_Add(payload){
  return new Promise((resolve,reject)=>{
    const cb = 'jsonp_cb_'+Date.now()+'_'+Math.floor(Math.random()*10000);
    window[cb] = function(res){
      try{ delete window[cb]; script.remove(); }catch(e){}
      resolve(res);
    };
    const url = new URL(GAS_URL);
    url.searchParams.append('action','add');
    url.searchParams.append('text', JSON.stringify(payload));
    url.searchParams.append('callback', cb);
    const script = document.createElement('script');
    script.src = url.toString();
    script.onerror = function(){ try{ delete window[cb]; script.remove(); }catch(e){}; reject(new Error('Network or load error')); };
    document.body.appendChild(script);
  });
}

/* ================== QR Scanner (html5-qrcode) ================== */
let qrReaderInstance = null;
async function startQRScanner(){
  document.getElementById('responseMessage').innerText = '';
  showSection('qr-section');
  const qrReaderEl = document.getElementById('qr-reader');
  qrReaderEl.innerHTML = '';
  qrReaderInstance = new Html5Qrcode('qr-reader');

  try {
    await qrReaderInstance.start(
      { facingMode: 'environment' },
      { fps: 10, qrbox: { width: 250, height: 250 } },
      async (decodedText) => { // onSuccess
        await onQrDecoded(decodedText);
      },
      (error) => { /* onFailure per frame - ignore */ }
    );
  } catch(err) {
    document.getElementById('responseMessage').innerText = 'ไม่สามารถเปิดกล้องได้ หรือเปิดสิทธิ์ไม่สำเร็จ';
  }
}

async function stopQRScanner(){
  if(qrReaderInstance){
    try{ await qrReaderInstance.stop(); }catch(e){}
    qrReaderInstance = null;
  }
}

/* ================== เมื่อ QR ถูกอ่าน ================== */
let pendingPayload = null;
async function onQrDecoded(decodedText){
  await stopQRScanner();
  if(!decodedText || !decodedText.trim()){
    document.getElementById('responseMessage').innerText = 'QR code ไม่ถูกต้อง';
    return;
  }

  const name = (document.getElementById('displayName').value || '').trim();
  const phone = (document.getElementById('phone').value || '').trim();
  if(!name){
    alert('กรุณากรอกชื่อ (displayName) ก่อนสแกน');
    return;
  }
  if(!phone || !(/^0[689]\d{8}$/.test(phone))){
    alert('กรุณากรอกเบอร์โทรศัพท์มือถือ (10 หลัก) ให้ถูกต้อง');
    return;
  }

  // สร้าง payload ในรูปแบบที่ GAS เดิมน่าจะต้องการ
  const now = new Date();
  // UUID แบบสุ่ม (web-specific)
  const uuid = 'web-' + Math.floor(Math.random()*1000000000);
  pendingPayload = {
    UUID: uuid,
    Name: name,
    Phone: phone,
    Secrete: decodedText.trim(),
    Latitude: Number(currentMockPos.latitude.toFixed(12)),
    Longitude: Number(currentMockPos.longitude.toFixed(12))
  };

  // แสดงสรุป ให้ผู้ใช้ยืนยันก่อนส่ง (pattern เหมือนที่ต้องการ)
  const thaiDate = `${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}-${now.getFullYear()}`;
  const thaiTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  const summary = `ลงเวลาสำเร็จ\n--------------------\nคุณ: ${pendingPayload.Name}\nเบอร์โทร: ${pendingPayload.Phone}\nวันที่: ${thaiDate}\nเวลา: ${thaiTime} น.`;
  document.getElementById('confirmText').innerText = summary;
  document.getElementById('confirmModal').classList.remove('hidden');
}

/* ยกเลิกการยืนยัน */
document.getElementById('cancelConfirm').addEventListener('click', ()=>{
  document.getElementById('confirmModal').classList.add('hidden');
  // ให้สามารถสแกนใหม่ได้
  startQRScanner();
});

/* ยืนยันและส่งข้อมูลจริงไป GAS */
document.getElementById('sendConfirm').addEventListener('click', async ()=>{
  document.getElementById('confirmModal').classList.add('hidden');
  document.getElementById('responseMessage').innerText = 'กำลังส่งข้อมูลไปยังระบบ...';
  try {
    const res = await callGAS_Add(pendingPayload);
    // แสดงผล และไปหน้า success
    document.getElementById('responseMessage').innerText = '';
    showSection('success-section');
    // ข้อความ success — ระบบ GAS เดิมจะส่งข้อความไป LINE OA
    document.getElementById('successMessage').innerText = 'ส่งข้อมูลสำเร็จ! ระบบเดิมจะส่งข้อความยืนยันใน LINE OA ของหน่วยงาน';
    // แสดง raw response ถ้าต้องการดู
    const raw = document.getElementById('rawResponse');
    raw.classList.remove('hidden');
    raw.textContent = JSON.stringify(res, null, 2);
  } catch(err) {
    document.getElementById('responseMessage').innerText = 'เกิดข้อผิดพลาดในการส่งข้อมูล: ' + (err && err.message ? err.message : String(err));
    // ให้ปุ่มสแกนใหม่
    document.getElementById('retryScanButton').classList.remove('hidden');
  }
});

/* ปุ่มหยุดกล้อง / สแกนใหม่ / ลงเวลาใหม่ */
document.getElementById('stopScanButton').addEventListener('click', async ()=>{
  await stopQRScanner();
  document.getElementById('responseMessage').innerText = 'กล้องหยุดแล้ว';
});
document.getElementById('retryScanButton').addEventListener('click', async ()=>{
  document.getElementById('retryScanButton').classList.add('hidden');
  await startQRScanner();
});
document.getElementById('newEntryBtn').addEventListener('click', ()=>{
  // รีเซ็ตฟอร์ม (แต่เก็บชื่อเดิมไว้)
  showSection('form-section');
  document.getElementById('rawResponse').classList.add('hidden');
});

/* ปุ่มถัดไป — เปิดสแกน (ตรวจความถูกต้องเบื้องต้น) */
document.getElementById('nextButton').addEventListener('click', async ()=>{
  const name = (document.getElementById('displayName').value || '').trim();
  const phone = (document.getElementById('phone').value || '').trim();
  if(!name){ alert('กรุณากรอกชื่อก่อน'); return; }
  if(!phone || !(/^0[689]\d{8}$/.test(phone))){ alert('กรุณากรอกเบอร์มือถือ 10 หลัก'); return; }

  // สร้างพิกัดใหม่ทุกครั้งที่เริ่ม (เลือกระหว่างสร้างใหม่หรือใช้ที่มี)
  currentMockPos = randomLocation();
  document.getElementById('posDisplay').innerText = `${currentMockPos.latitude.toFixed(6)}, ${currentMockPos.longitude.toFixed(6)} (±${currentMockPos.distanceMeters} m)`;

  // เริ่มสแกน (เหมาะสำหรับมือถือ)
  await startQRScanner();
});

/* ป้องกันการปิดหน้าโดยไม่ตั้งใจ: stop scanner */
window.addEventListener('beforeunload', async (e) => {
  try{ await stopQRScanner(); }catch(e){}
});

/* หมายเหตุ: ระบบนี้ไม่ใช้ LIFF login (เพื่อตัดปัญหา redirect) */
/* ส่งข้อมูลแบบ JSONP ไป GAS เดิมที่คุณให้มา (GAS จะจัดการบันทึกและส่งข้อความในระบบของเขา) */
</script>
</body>
</html>
