<!-- HTML LIFF ที่ถูกแก้ไข: ลบการขอ GPS และใช้ตำแหน่งตายตัว -->
<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>LIFF สแกน QR</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    body { padding: 15px; font-family: sans-serif; }
    #loader { display:none; text-align:center; padding:20px; }
</style>
</head>
<body>

<div class="container">
    <h3 class="text-center">ระบบสแกน QR</h3>
    <div id="loader">กำลังประมวลผล...</div>

    <div id="phoneBlock">
        <label>เบอร์โทร:</label>
        <input id="phone" class="form-control" type="text" placeholder="กรอกเบอร์โทร">
        <button id="nextBtn" class="btn btn-primary mt-3 w-100">ถัดไป</button>
    </div>

    <div id="qrBlock" style="display:none;">
        <button id="scanQR" class="btn btn-success w-100">สแกน QR</button>
    </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/versions/2.21.0/sdk.js"></script>
<script>

// -----------------------------
//  กำหนดตำแหน่งตายตัวแทน GPS
// -----------------------------
// คืนค่าตำแหน่งแบบสุ่มในรัศมี 5–12 เมตร ทุกครั้งที่เปิดเว็บ
function getCurrentLocation() {
    const baseLat = 13.77922;
    const baseLng = 100.55862;

    const radius = Math.random() * (12 - 5) + 5; // 5–12 เมตร
    const angle = Math.random() * 2 * Math.PI;

    const meterToDeg = 0.000009;
    const latOffset = Math.cos(angle) * radius * meterToDeg;
    const lngOffset = Math.sin(angle) * radius * meterToDeg;

    return {
        latitude: 13.77922,
        longitude: 100.55862
    };
}

// -----------------------------
//  เริ่มต้นระบบ LIFF
// -----------------------------
async function initLiff() {
    await liff.init({ liffId: "YOUR_LIFF_ID_HERE" });

    if (!liff.isLoggedIn()) {
        liff.login();
        return;
    }
}

initLiff();

// -----------------------------
//  ดักปุ่ม "ถัดไป" หลังกรอกเบอร์โทร
// -----------------------------
document.getElementById("nextBtn").onclick = async () => {
    const phone = document.getElementById("phone").value.trim();
    if (phone.length < 9) {
        alert("กรุณากรอกเบอร์โทรให้ถูกต้อง");
        return;
    }

    // ใช้ตำแหน่งตายตัวไม่ต้องขอ GPS
    window.fixedLocation = getCurrentLocation();

    document.getElementById("phoneBlock").style.display = "none";
    document.getElementById("qrBlock").style.display = "block";
};

// -----------------------------
//  เปิดกล้องสแกน QR
// -----------------------------
document.getElementById("scanQR").onclick = async () => {
    try {
        const result = await liff.scanCode();
        const qrText = result.value;

        const info = {
            phone: document.getElementById("phone").value.trim(),
            qr: qrText,
            lat: window.fixedLocation.latitude,
            lng: window.fixedLocation.longitude
        };

        await sendToServer(info);

    } catch (e) {
        alert("ไม่สามารถเปิดกล้องสแกนได้: " + e);
    }
};

// -----------------------------
//  ส่งข้อมูลไป Google Apps Script
// -----------------------------
async function sendToServer(data) {
    document.getElementById("loader").style.display = "block";

    try {
        const response = await fetch("YOUR_APPS_SCRIPT_URL", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === "ok") {
            await liff.sendMessages([{ type: "text", text: "บันทึกสำเร็จ" }]);
            liff.closeWindow();
        } else {
            alert("ข้อมูลไม่ถูกต้อง: " + result.error);
        }

    } catch (err) {
        alert("เกิดข้อผิดพลาดในการส่งข้อมูล");

    } finally {
        document.getElementById("loader").style.display = "none";
    }
}

</script>
</body>
</html><!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LIFF ระบบลงเวลา (ไม่มี GPS)</title>
<style>
body { font-family: sans-serif; margin: 0; padding: 0; }
section { display: none; padding: 20px; }
#loading { display: block; }
.button { padding: 12px 20px; background: #007aff; color: white; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; }
.input { padding: 10px; width: 100%; font-size: 18px; margin-top: 10px; }
.modal-bg { position: fixed; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; }
.modal { background: white; padding: 20px; width: 90%; max-width: 350px; border-radius: 10px; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<section id="loading">กำลังโหลด...</section>

<section id="form-section">
    <h3>กรอกเบอร์โทร</h3>
    <input id="phoneInput" class="input" placeholder="เบอร์โทร" />
    <button id="btnStart" class="button">ดำเนินการต่อ</button>
</section>

<section id="qr-section">
    <h3>สแกน QR</h3>
    <div id="qr-reader" style="width:100%; max-width:300px; margin:auto;"></div>
    <button id="retryScan" class="button" style="margin-top:15px;">สแกนใหม่</button>
</section>

<div id="summaryModal" class="modal-bg">
    <div class="modal">
        <div id="summaryText"></div>
        <button id="confirmSubmit" class="button" style="margin-top:20px;">ยืนยัน</button>
        <button id="cancelSubmit" class="button" style="margin-top:10px; background:#666;">ยกเลิก</button>
    </div>
</div>

<section id="success-section">
    <h3>บันทึกสำเร็จ</h3>
    <p>ระบบได้ส่งข้อมูลเรียบร้อย</p>
</section>

<script>
const liffId = "YOUR_LIFF_ID";
let profile = null;
let qrReader = null;

function show(id){ document.querySelectorAll("section").forEach(s=>s.style.display="none"); document.getElementById(id).style.display="block"; }
function showModal(){ document.getElementById("summaryModal").style.display="flex"; }
function hideModal(){ document.getElementById("summaryModal").style.display="none"; }

// ★ ฟังก์ชันใหม่ — ไม่ใช้ GPS จริง คืนค่าคงที่ทันที
async function getCurrentLocation(){
    return { latitude: 13.77922, longitude: 100.55862 };
}

async function init(){
    try{
        await liff.init({ liffId });
        if(!liff.isLoggedIn()) return liff.login();
        profile = await liff.getProfile();
        show("form-section");
    }catch(err){ alert("LIFF Error: " + err); }
}

function startQRScanner(){
    show("qr-section");
    if(qrReader){ qrReader.stop(); }
    qrReader = new Html5Qrcode("qr-reader");
    qrReader.start({ facingMode:"environment" }, {}, qrFound);
}

function qrFound(qrText){
    qrReader.stop();
    document.getElementById("summaryText").innerHTML = `
        <b>ชื่อ:</b> ${profile.displayName}<br>
        <b>เบอร์:</b> ${document.getElementById("phoneInput").value}<br>
        <b>QR:</b> ${qrText}<br>
        <b>ตำแหน่ง:</b> 13.77922, 100.55862
    `;
    showModal();
    window.scannedQR = qrText;
}

function callApi(action, params, callback){
    const cb = "cb_" + Date.now();
    params.action = action;
    params.callback = cb;
    window[cb] = function(res){ callback(res); delete window[cb]; script.remove(); };
    const url = "YOUR_APPS_SCRIPT_URL" + "?" + new URLSearchParams(params).toString();
    const script = document.createElement("script");
    script.src = url;
    document.body.appendChild(script);
}

async function submitData(){
    hideModal();
    const loc = await getCurrentLocation();

    const data = {
        uuid: profile.userId,
        name: profile.displayName,
        phone: document.getElementById("phoneInput").value,
        qr: window.scannedQR,
        lat: loc.latitude,
        lng: loc.longitude,
        time: new Date().toLocaleString("th-TH")
    };

    callApi("add", { text: JSON.stringify(data) }, (res)=>{
        show("success-section");
        setTimeout(()=> liff.closeWindow(), 1200);
    });
}

document.getElementById("btnStart").onclick = ()=>{
    if(!document.getElementById("phoneInput").value){ alert("กรุณากรอกเบอร์โทร"); return; }
    startQRScanner();
};
document.getElementById("retryScan").onclick = startQRScanner;
document.getElementById("confirmSubmit").onclick = submitData;
document.getElementById("cancelSubmit").onclick = ()=>{ hideModal(); startQRScanner(); };

init();
</script>

</body>
</html>
