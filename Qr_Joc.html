<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>QR Code Check-In</title>
<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet" />
<style>
body { font-family: 'Kanit', sans-serif; margin:0; padding:20px; display:flex; flex-direction:column; align-items:center; text-align:center; background:#f4f4f9; color:#333; }
.hidden { display:none; }
#loading-message { margin-top:40px; font-size:1.2em; }
header { margin-bottom:20px; }
header img { width:80px; }
section { background:white; padding:25px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); width:100%; max-width:500px; box-sizing:border-box; }
label { display:block; margin-bottom:12px; font-weight:bold; }
input, button { width:100%; padding:12px; margin-bottom:20px; border:1px solid #ccc; border-radius:8px; font-family:'Kanit',sans-serif; box-sizing:border-box; font-size:16px; }
button { background:#00B900; color:#fff; border:none; cursor:pointer; font-weight:bold; transition:background 0.3s; }
button:hover { background:#009900; }
.message { text-align:center; margin-top:15px; font-size:1em; color:#555; line-height:1.5; }
#qr-reader { margin-top:20px; border:1px dashed #ccc; border-radius:8px; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
.modal-content { background:white; margin:auto; padding:25px; border-radius:12px; text-align:left; width:90%; max-width:400px; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
.modal-content h2 { text-align:center; margin-top:0; }
.modal-buttons { display:flex; justify-content:space-evenly; margin-top:25px; gap:15px; }
.modal-buttons button { width:100%; }
#cancelPhoneButton { background:#f44336; } #cancelPhoneButton:hover { background:#d32f2f; }
#confirmPhoneButton { background:#00B900; } #confirmPhoneButton:hover { background:#009900; }
</style>
</head>
<body>

<div id="loading-message"><p>กำลังเตรียมแอปพลิเคชัน กรุณารอสักครู่...</p></div>

<header id="header" class="hidden">
    <img src="https://drive.google.com/thumbnail?id=1biw0LeK_X0ntKPdH4-8XaPUcl1yGDl59" alt="Logo" />
</header>

<section id="form-section" class="hidden">
    <h1>ระบบลงเวลาเข้าเรียน</h1>
    <p>ณ สศท.สปท.</p>
    <form id="dataForm">
        <label for="phone">โปรดกรอกหมายเลขโทรศัพท์</label>
        <input type="tel" id="phone" name="Phone" required pattern="^0[689]\d{8}$" title="กรุณากรอกเบอร์โทรศัพท์มือถือ 10 หลัก" />
        <button type="button" id="nextButton">ขั้นตอนถัดไป</button>
    </form>
</section>

<section id="qr-section" class="hidden">
    <h1>แสกน QR Code เพื่อประทับเวลา</h1>
    <div id="qr-reader"></div>
    <div id="responseMessage" style="font-weight:bold;"></div>
</section>

<div id="phoneConfirmModal" class="modal">
    <div class="modal-content">
        <h2>ยืนยันข้อมูล</h2>
        <p>หมายเลขโทรศัพท์: <strong id="phoneDisplay"></strong></p>
        <div class="modal-buttons">
            <button id="cancelPhoneButton">ยกเลิก</button>
            <button id="confirmPhoneButton">ยืนยัน</button>
        </div>
    </div>
</div>

<script>
const liffId = "2006142476-expQgry9"; 
const scriptURL = 'https://script.google.com/macros/s/AKfycby8iE0HQ4V_8rgjHNalxp1bM4VFxxz5JBXkUc0qpqkLxcYxM1iE5vmhQO0wCoNG1eIfCg/exec';
let formData = {};
let qrReaderInstance = null;

document.addEventListener('DOMContentLoaded', () => {
    const loadingMessage = document.getElementById('loading-message');
    const header = document.getElementById('header');
    const phoneModal = document.getElementById('phoneConfirmModal');
    const responseMessage = document.getElementById('responseMessage');

    async function main() {
        try { await liff.init({ liffId }); } 
        catch (err) { loadingMessage.innerText = "เกิดข้อผิดพลาดในการเริ่มต้น LIFF"; return; }
        if (!liff.isLoggedIn()) liff.login();
        else { loadingMessage.classList.add('hidden'); header.classList.remove('hidden'); showSection('form-section'); }
    }

    function showSection(sectionId) {
        document.querySelectorAll('section').forEach(s=>s.classList.toggle('hidden', s.id!==sectionId));
    }

    function getMockLocation() {
        const baseLat = 13.77922, baseLng = 100.55862;
        const offset = ()=> (Math.random()-0.5)*0.0005;
        return { coords:{ latitude: baseLat+offset(), longitude: baseLng+offset() } };
    }

    async function getDeviceInfo() {
        let deviceUUID, displayName = "Unknown";
        try { const profile = await liff.getProfile(); deviceUUID = profile.userId; displayName = profile.displayName; } 
        catch(e){ deviceUUID=`no-liff-${crypto.randomUUID()}`; }
        return { uuid:deviceUUID, displayName:displayName };
    }

    function callApi(action, params) {
        return new Promise((resolve,reject)=>{
            const callbackName=`jsonpCallback_${Date.now()}${Math.floor(Math.random()*1000)}`;
            window[callbackName]=(result)=>{ delete window[callbackName]; document.body.removeChild(scriptEl); resolve(result); };
            const url=new URL(scriptURL); url.searchParams.append('action',action); 
            for(const k in params) url.searchParams.append(k,params[k]); 
            url.searchParams.append('callback',callbackName);
            const scriptEl=document.createElement('script'); scriptEl.src=url.toString();
            scriptEl.onerror=()=>{ delete window[callbackName]; document.body.removeChild(scriptEl); reject(new Error("API call failed")); };
            document.body.appendChild(scriptEl);
        });
    }

    async function handleQrScan(decodedText) {
        if(qrReaderInstance){ await qrReaderInstance.stop().catch(()=>{}); qrReaderInstance=null; }
        if(!decodedText || !decodedText.trim()){ responseMessage.innerText='QR code ไม่ถูกต้อง โปรดสแกนใหม่'; setTimeout(startQRScanner,2500); return; }

        const now=new Date();
        const thaiDate=`${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}-${now.getFullYear()}`;
        const thaiTime=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        formData.Timestamp = `${thaiDate} ${thaiTime}`;
        formData.QR = decodedText;

        try {
            await callApi('add',{text:JSON.stringify(formData)});
            responseMessage.innerText='ส่งข้อมูลสำเร็จ! กำลังกลับไป LINE...';
            setTimeout(()=>{ liff.closeWindow(); }, 1500);
        } catch(err){ responseMessage.innerText='เกิดข้อผิดพลาดในการส่งข้อมูล'; }
    }

    async function startQRScanner() {
        responseMessage.innerText='';
        showSection('qr-section');
        document.getElementById('qr-reader').innerHTML='';
        if(liff.isInClient() && liff.isApiAvailable('scanCodeV2')) {
            try {
                const result = await liff.scanCodeV2();
                if(result.value) await handleQrScan(result.value);
            } catch(err){ if(err.code==="USER_CANCEL") showSection('form-section'); else alert('เกิดข้อผิดพลาดในการใช้กล้อง LINE'); }
        } else {
            responseMessage.innerText='กำลังเปิดกล้อง...';
            qrReaderInstance = new Html5Qrcode('qr-reader');
            qrReaderInstance.start({facingMode:'environment'},{fps:10,qrbox:{width:250,height:250}},decodedText=>handleQrScan(decodedText),()=>{}).catch(()=>{ responseMessage.innerText='ไม่สามารถเปิดกล้องได้ กรุณาอนุญาต'; });
        }
    }

    document.getElementById('nextButton').addEventListener('click',()=>{
        const phoneInput=document.getElementById('phone');
        if(!phoneInput.checkValidity()){ alert(phoneInput.title); return; }
        document.getElementById('phoneDisplay').innerText=phoneInput.value;
        phoneModal.style.display='flex';
    });

    document.getElementById('confirmPhoneButton').addEventListener('click',async()=>{
        phoneModal.style.display='none';
        const [deviceInfo, position] = await Promise.all([getDeviceInfo(), Promise.resolve(getMockLocation())]);
        formData = {
            Phone: document.getElementById('phone').value.trim(),
            UUID: deviceInfo.uuid,
            Name: deviceInfo.displayName,
            Latitude: position.coords.latitude,
            Longitude: position.coords.longitude
        };
        await startQRScanner();
    });

    document.getElementById('cancelPhoneButton').addEventListener('click',()=>phoneModal.style.display='none');

    main();
});
</script>
</body>
</html>
